/**
 * Copyright (C) 2024 New York City Department of Health and Mental Hygiene, Bureau of Immunization
 * Contributions by HLN Consulting, LLC
 *
 * This program is free software: you can redistribute it and/or modify it under the terms of the GNU
 * Lesser General Public License as published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version. You should have received a copy of the GNU Lesser
 * General Public License along with this program. If not, see <http://www.gnu.org/licenses/> for more
 * details.
 *
 * The above-named contributors (HLN Consulting, LLC) are also licensed by the New York City
 * Department of Health and Mental Hygiene, Bureau of Immunization to have (without restriction,
 * limitation, and warranty) complete irrevocable access and rights to this project.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; THE
 *
 * SOFTWARE IS PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING,
 * BUT NOT LIMITED TO, WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE COPYRIGHT HOLDERS, IF ANY, OR DEVELOPERS BE LIABLE FOR
 * ANY CLAIM, DAMAGES, OR OTHER LIABILITY OF ANY KIND, ARISING FROM, OUT OF, OR IN CONNECTION WITH
 * THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 * For more information about this software, see http://www.hln.com/ice or send
 * correspondence to ice@hln.com.
 */

package knowledgeModule.gov.nyc.cir.ice

import java.util.List
import java.util.Set
import java.util.Date
import org.opencds.vmr.v1_0.internal.EvalTime
import org.opencds.vmr.v1_0.internal.EvaluatedPerson
import org.cdsframework.ice.service.DiseaseImmunity
import org.cdsframework.ice.service.DoseRule
import org.cdsframework.ice.service.DoseStatus
import org.cdsframework.ice.service.ICEFactTypeFinding
import org.cdsframework.ice.service.ICEIntervalFactTypeFinding
import org.cdsframework.ice.service.ICELogicHelper
import org.cdsframework.ice.service.Recommendation
import org.cdsframework.ice.service.RecommendationStatus
import org.cdsframework.ice.service.Season
import org.cdsframework.ice.service.Schedule
import org.cdsframework.ice.service.SeriesRules
import org.cdsframework.ice.service.TargetDose
import org.cdsframework.ice.service.TargetSeries
import org.cdsframework.ice.util.TimePeriod
import org.cdsframework.ice.util.TimePeriod.DurationType
import org.cdsframework.ice.service.Vaccine
import org.cdsframework.ice.supportingdatatmp.SupportedFactConcept
import org.cdsframework.ice.supportingdata.BaseDataRecommendationReason

expander ../../knowledgeCommon/org.cdsframework.ice/org.cdsframework^ICE^1.0.0.dsl

global java.util.Date evalTime
global org.cdsframework.ice.service.Schedule schedule



/*****************************************************************************************************************************************************************************************************************
 ===> Series: ALL
*****************************************************************************************************************************************************************************************************************/

/////////////////////
// ===> Non-U.S. vaccine that does not count towards vaccination, administered on or after 9/12/2023   
//    If the patient has a prior formulation COVID-19 shot that does not count towards U.S. vaccination (CVX 500, CVX 501, CVX 503, CVX 504, CVX 505, CVX 506, CVX 507, CVX 508, CVX 509, CVX 513, CVX 514, CVX 515, CVX 516, CVX 517, CVX 518, CVX 521) administered on or after 9/12/2023, 
//    the intervals to the next target dose are: 
//        + Absolute Minimum Interval = 8 weeks - 4 days
//        + Minimum Interval = 8 weeks
//        + Recommended Interval = 8 weeks 
//    If a prior formulation of a COVID-19 vaccine, excluding CVX 211, is administered on or after 9/12/2023, then the Evaluation is Invalid and the reason code is VACCINE_NOT_ALLOWED_FOR_THIS_DOSE.
//////////////////////

rule "COVID-19(Sep2023+): If a prior formulation that does not count towards U.S. vaccination is administered on or after 9/12/2023 (for any Sept 2023 onward COVID-19 Series), recommend earliest & recommended interval of 8 weeks to the next dose"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the Series is not Complete
		There is an administered shot $priorShot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- that has already been evaluated
			- the vaccine administered a member of ("ICE500", "ICE501", "ICE503", "ICE504", "ICE505", "ICE506", "ICE507", "ICE508", "ICE509", "ICE513", "ICE514", "ICE515", "ICE516", "ICE517", "ICE518", "ICE521")
			- the administration date of the shot is >= "12-Sep-2023"
			- make note of the Date this Shot was Administered as $previousShotDate
		There does not exist an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- that has already been evaluated
			- the administration date of the shot is > $previousShotDate
			- the vaccine administered a member of ("ICE500", "ICE501", "ICE503", "ICE504", "ICE505", "ICE506", "ICE507", "ICE508", "ICE509", "ICE513", "ICE514", "ICE515", "ICE516", "ICE517", "ICE518", "ICE521")
	then
		Create a Recommendation as $r for the Series $targetSeries
		Add "8w" to $previousShotDate and make note of the newly calculated date as $dtCalculated
		Set the recommendation Earliest Forecast Date for $r to $dtCalculated
		Set the recommendation Recommended Forecast Date for $r to $dtCalculated
		Include the Recommendation $r for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


///////
// For all COVID-19 vaccine seasons: 
//    * COVID-19 shots administered are evaluated based on the rules in effect as of the shot administration date.  (evaluation rule, handled in evaluation rule set)
//    * COVID-19 recommendations are based on the rules in effect as of the evaluation date. (recommendation rule, handled here)
///////
rule "COVID-19(Sep2023+): If the evaluation date is prior to the 2024-2025 season start date (8/22/2024), the target series is in the 2023-2024 season, and the series is complete, recommendation is NOT_RECOMMENDED / COMPLETE"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the Series is Complete
			- the Series belongs to the Season with name "COVID19Sep2023Season"
		There exists a Season
			- the name of the Season is "COVID19Aug2024Season"
			- the fully specified season start date is > evalTime
	then
		Create a Recommendation as $recommendation with Status RecommendationStatus.NOT_RECOMMENDED for the Series $targetSeries
		Set the Recommendation Reason for $recommendation to "RECOMMENDATION_REASON_CONCEPT.COMPLETE"
		Include the Recommendation $recommendation for Consideration in the final Forecast of the Series
		Mark Forecasting of the Series $targetSeries Complete
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


/////////////////////
// START
// When recommending in the Seasonal COVID-19 Pfizer Series (< 5 years) or the Seasonal COVID-19 Moderna Series (< 5 years), recommend at the CVX code level. Recommend the vaccine product applicable 
// for the series and the patient's age, based on the COVID-19 Vaccines table
/////////////////////

rule "COVID-19(Sep2023+ Moderna < 5yrs Series Abstract): Recommend the appropriate age-specific vaccine"
	dialect "mvel"
	agenda-group "RecommendationForecast^postCustomRecommendationCheck^COVID19Sep2023Season"
	when
		There is a Series $targetSeries
			- a Forecast for the Series has been made and a Recommendation Date has been determined
			- the Series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023ModernaLT5ySeries"
			- make note of the Recommendation Date as $recommendationDate
			- post processing on the Series forecast has not already been run
		The patient information $assign_oEvaluatedPerson must be known to complete writing this rule
			- make note of the patient's birthdate as $dtBirthDate
	then
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ Moderna < 5yrs Series): If the next recommended dose is at > 6m and < 12y of age, recommend Moderna 6m-11y (CVX 311) at the vaccine level" 
		extends "COVID-19(Sep2023+ Moderna < 5yrs Series Abstract): Recommend the appropriate age-specific vaccine"
	dialect "mvel"
	agenda-group "RecommendationForecast^postCustomRecommendationCheck^COVID19Sep2023Season"
	activation-group "RecommendationForecast^postRecommendationCheck^COVID19Sep2023Season^VaccineGroupOrVaccineRecommendation"
	when
		Confirm elapsed time between $dtBirthDate and $recommendationDate >= "6m" && elapsed time between $dtBirthDate and $recommendationDate < "12y" && elapsed time between $dtBirthDate and evalTime < "12y"
	then
		Create a Recommendation as $oRecommendation for the Series $targetSeries
		Set the Recommendation Vaccine for $oRecommendation to "ICE311"
		Include the Recommendation $oRecommendation for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ Moderna < 5yrs Series): If the next recommended dose is at >= 12y of age, recommend Moderna 12y (CVX 312) at the vaccine level" 
		extends "COVID-19(Sep2023+ Moderna < 5yrs Series Abstract): Recommend the appropriate age-specific vaccine"	
	dialect "mvel"
	agenda-group "RecommendationForecast^postCustomRecommendationCheck^COVID19Sep2023Season"
	activation-group "RecommendationForecast^postRecommendationCheck^COVID19Sep2023Season^VaccineGroupOrVaccineRecommendation"
	when
		Confirm elapsed time between $dtBirthDate and $recommendationDate >= "12y" || $recommendationDate <= evalTime && elapsed time between $dtBirthDate and evalTime >= "12y"
	then
		Create a Recommendation as $oRecommendation for the Series $targetSeries
		Set the Recommendation Vaccine for $oRecommendation to "ICE312"
		Include the Recommendation $oRecommendation for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ Pfizer < 5yrs Series Abstract): Recommend the appropriate age-specific vaccine"
	dialect "mvel"
	agenda-group "RecommendationForecast^postCustomRecommendationCheck^COVID19Sep2023Season"
	when
		There is a Series $targetSeries
			- a Forecast for the Series has been made and a Recommendation Date has been determined
			- the Series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023PfizerLT5ySeries"
			- make note of the Recommendation Date as $recommendationDate
			- post processing on the Series forecast has not already been run
		The patient information $assign_oEvaluatedPerson must be known to complete writing this rule
			- make note of the patient's birthdate as $dtBirthDate
	then
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ Pfizer < 5yrs Series): If the next recommended dose is at >= 6m and < 5y of age, recommend Pfizer 6m-5y (CVX 308) at the vaccine level" 
		extends "COVID-19(Sep2023+ Pfizer < 5yrs Series Abstract): Recommend the appropriate age-specific vaccine"
	dialect "mvel"
	agenda-group "RecommendationForecast^postCustomRecommendationCheck^COVID19Sep2023Season"
	activation-group "RecommendationForecast^postRecommendationCheck^COVID19Sep2023Season^VaccineGroupOrVaccineRecommendation"
	when
		Confirm elapsed time between $dtBirthDate and $recommendationDate >= "6m" && elapsed time between $dtBirthDate and $recommendationDate < "5y" && elapsed time between $dtBirthDate and evalTime < "5y" 
	then
		Create a Recommendation as $oRecommendation for the Series $targetSeries
		Set the Recommendation Vaccine for $oRecommendation to "ICE308"
		Include the Recommendation $oRecommendation for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ Pfizer < 5yrs Series): If the next recommended dose is at >= 5y and < 12y of age, recommend Pfizer 5-11y (CVX 310) at the vaccine level" 
		extends "COVID-19(Sep2023+ Pfizer < 5yrs Series Abstract): Recommend the appropriate age-specific vaccine"
	dialect "mvel"
	agenda-group "RecommendationForecast^postCustomRecommendationCheck^COVID19Sep2023Season"
	activation-group "RecommendationForecast^postRecommendationCheck^COVID19Sep2023Season^VaccineGroupOrVaccineRecommendation"
	when
		Confirm elapsed time between $dtBirthDate and $recommendationDate >= "5y" && elapsed time between $dtBirthDate and $recommendationDate < "12y" || $recommendationDate <= evalTime && elapsed time between $dtBirthDate and evalTime >= "5y" && elapsed time between $dtBirthDate and evalTime < "12y"
	then
		Create a Recommendation as $oRecommendation for the Series $targetSeries
		Set the Recommendation Vaccine for $oRecommendation to "ICE310"
		Include the Recommendation $oRecommendation for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ Pfizer < 5yrs Series): If the next recommended dose is at >= 12y of age, recommend Pfizer 12y+ (CVX 309) at the vaccine level" 
		extends "COVID-19(Sep2023+ Pfizer < 5yrs Series Abstract): Recommend the appropriate age-specific vaccine"
	dialect "mvel"
	agenda-group "RecommendationForecast^postCustomRecommendationCheck^COVID19Sep2023Season"
	activation-group "RecommendationForecast^postRecommendationCheck^COVID19Sep2023Season^VaccineGroupOrVaccineRecommendation"
	when
		Confirm elapsed time between $dtBirthDate and $recommendationDate >= "12y" || $recommendationDate <= evalTime && elapsed time between $dtBirthDate and evalTime >= "12y"
	then
		Create a Recommendation as $oRecommendation for the Series $targetSeries
		Set the Recommendation Vaccine for $oRecommendation to "ICE309"
		Include the Recommendation $oRecommendation for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


/////////////////////
// END Recommending at the CVX code level for Moderna/Pfizer < 5yrs Series... 
/////////////////////


/////////////////////
// Exception to vaccine-specific recommendation rules above.
// When recommending in the Seasonal COVID-19 Pfizer Series (< 5 years) or the Seasonal COVID-19 Moderna Series (< 5 years), recommend at the CVX code level and recommend the vaccine product applicable for the series and the patient's age, 
// based on the COVID-19 Vaccines table, unless the following exception applies: 
//     + If the patient is >= 5 years as of the recommended date or the evaluation date, and either the recommendation date or the evaluation date is >= 8 weeks from the last administered COVID-19 shot, recommend at the vaccine group level.
//       This rule overrides specific CVX code vaccine recommendations above.
/////////////////////

rule "COVID-19(Sep2023+): If the patient is >= 5 years as of the recommended date or the evaluation date, and either the recommendation date or the evaluation date is >= 8 weeks from the last administered COVID-19 shot, recommend at the vaccine group level"
	dialect "mvel"
	agenda-group "RecommendationForecast^postCustomRecommendationCheck^COVID19Sep2023Season"
	activation-group "RecommendationForecast^postRecommendationCheck^COVID19Sep2023Season^VaccineGroupOrVaccineRecommendation"
	salience 10
	when
		There is a Series $targetSeries
			- a Forecast for the Series has been made and a Recommendation Date has been determined
			- the Series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series a member of ("COVID19Sep2023PfizerLT5ySeries", "COVID19Sep2023ModernaLT5ySeries")
			- post processing on the Series forecast has not already been run
			- make note of the recommendation date as $recommendationDate
			- make note of the date that the most recent shot was administered as $lastAdministeredShotDate
		The patient information $assign_oEvaluatedPerson must be known to complete writing this rule
			- make note of the patient's birthdate as $dtBirthDate
			- make note of the date as $dateAt5yrs when the patient is "5y" of age
		Confirm the date evalTime is on the same date or after $dateAt5yrs || the date $recommendationDate is on the same date or after $dateAt5yrs
		Confirm elapsed time between $lastAdministeredShotDate and evalTime >= "8w" || elapsed time between $lastAdministeredShotDate and $recommendationDate >= "8w"
	then
		Unset the Recommended Vaccine for the forecast in the Series $targetSeries 
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end

/////////////////////
// START
// Recommendation Age Rules ===> All Series ; v1.42 release logic, still applicable
/////////////////////

rule "COVID-19(Sep2023+): If there are no shots administered, set the earliest/recommended/overdue age to the latter of age 6 months or the current season start date (*recommendationAgeCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "recommendationAgeCheck"
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the Series is not complete
			- the number of administered shots is == 0 
			- make note of the season start date as $seriesSeasonStartDate
		The patient information $oEvaluatedPerson must be known to complete writing this rule
        	- make note of the date as $dtDateAtAge6m when the patient is "6m" of age
	then
		Create a Recommendation as $r for the Series $targetSeries
		Set the recommendation Earliest Forecast Date for $r to the latter of $dtDateAtAge6m and $seriesSeasonStartDate
		Set the recommendation Recommended Forecast Date for $r to the latter of $dtDateAtAge6m and $seriesSeasonStartDate 
		Include the Recommendation $r for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+): If there are no shots administered, set the earliest age to the latter of age 6 months or the current season start date (*earliestAgeCheck*)"
		extends "COVID-19(Sep2023+): If there are no shots administered, set the earliest/recommended/overdue age to the latter of age 6 months or the current season start date (*recommendationAgeCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "earliestAgeCheck"
when
		// Series Table Earliest Age will be overridden by this rule and will not be enforced
	then
		// Nothing to do; earliest forecast date set in parent rule
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+): If there are no shots administered, set the latest recommended age to the latter of age 6 months or the current season start date (*latestRecommendedAgeCheck*)"
		extends "COVID-19(Sep2023+): If there are no shots administered, set the earliest/recommended/overdue age to the latter of age 6 months or the current season start date (*recommendationAgeCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "latestRecommendedAgeCheck"
when
		// Series Table Earliest Age will be overridden by this rule and will not be enforced
	then
		// Nothing to do; earliest forecast date set in parent rule
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end

/////////////////////
// END Recommendation Age Rules ===> All Series ; v1.42 release logic, still applicable
/////////////////////


/////////////////////
// For the 2023-2024 season, if the patient has >= 1 (invalid) COVID-19 shot(s) administered prior to 9/12/2023, but no doses on record, the intervals from the last shot, if prior to 9/12/2023, are:
//    Absolute Minimum Interval = 8 weeks - 4 days   (rule in Evaluation rule set)
//    Minimum Interval = 8 weeks  
//    Recommended Interval = 8 weeks  
/////////////////////

rule "COVID-19(Sep2023+): For the 2023-2024 season, the minimum interval and recommended interval from the most recent shot prior to 9/12/2023, when there are no doses on record, are 8w (*recommendationIntervalCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the Series belongs to the Season with name "COVID19Sep2023Season"
			- the Series is not Complete
			/////// (dose number check not needed; as there have not been any prior valid shots) - the effective dose number in the Series is == 1
		There does not exist an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- that has already been evaluated and whose shot validity is VALID
		There is an administered shot $mostRecentShot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is < "12-Sep-2023"
			- the shot is not ignored
			- make note of the date this shot was administered as $mostRecentShotDate
		There does not exist an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is > $mostRecentShotDate
			- the administration date of the shot is < "12-Sep-2023"
			- the shot is not ignored
	then
		Insert a Recommendation IceIntervalFact SupportedFactConcept._DOSE_INTERVAL_OVERRIDE.conceptCodeValue with TargetDose $mostRecentShot into working memory 
		Create a Recommendation as $r for the Series $targetSeries
		Add "8w" to $mostRecentShotDate and make note of the newly calculated date as $dtCalculatedEarliest
		Add "8w" to $mostRecentShotDate and make note of the newly calculated date as $dtCalculatedRecommended
		Set the recommendation Earliest Forecast Date for $r to $dtCalculatedEarliest
		Set the recommendation Recommended Forecast Date for $r to $dtCalculatedRecommended
		Include the Recommendation $r for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end

rule "COVID-19(Sep2023+): For the 2023-2024 season, the minimum interval and recommended interval from invalid shot prior to 9/12/2023 are 8w (*earliestIntevalCheck*)"
		extends "COVID-19(Sep2023+): For the 2023-2024 season, the minimum interval and recommended interval from the most recent shot prior to 9/12/2023, when there are no doses on record, are 8w (*recommendationIntervalCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	when
		// Conditions checked in parent rule; no additional conditions to check	
	then
		// Nothing to do; earliest forecast date set in parent rule
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end




/*****************************************************************************************************************************************************************************************************************
 ===> Series: >= 5 yrs START
*****************************************************************************************************************************************************************************************************************/

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Recommendation Age / Interval Rules
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////
// In the 2023-2024 season, the absolute minimum interval (see evaluation rules), minimum interval and recommended interval from dose 1 to dose 2 are, respectively, 4m-4d, 4m and 4m. 
// This overrides the value set in the series table, which was for 2023-2024 season. 
///////

rule "COVID-19(Sep2023+ >= 5yrs): For the 2023-2024 season, the minimum interval and recommended interval from dose 1 to dose 2 are, respectively, to 4m and 4m (*recommendationIntervalCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "recommendationIntervalCheck"
	// Since this rule is essentially a table-based rule, run this rule after all other custom rules
	salience -1
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the name of the series is "COVID19Sep2023gte5Series"
			- the Series belongs to the Season with name "COVID19Sep2023Season"
			- the Series is not Complete
			- the effective dose number in the Series is <= 2
		There is an administered shot $mostRecentShot
			/////// - the shot belongs to the Series $targetSeries
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- that has already been evaluated
			- the shot is not ignored
			- make note of the date this shot was administered as $mostRecentShotDate
		There does not exist an administered shot
			/////// - the shot belongs to the Series $targetSeries
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is > $mostRecentShotDate
			- the shot is not ignored
		There does not exist an IceIntervalFact
			- that has IceIntervalFact type IntervalFactType.RECOMMENDED
			- that has IceIntervalFact finding SupportedFactConcept._DOSE_INTERVAL_OVERRIDE.conceptCodeValue
			- that has IceIntervalFact current administered shot $mostRecentShot
	then
		Create a Recommendation as $r for the Series $targetSeries
		Add "4m" to $mostRecentShotDate and make note of the newly calculated date as $dtCalculatedEarliest
		Add "4m" to $mostRecentShotDate and make note of the newly calculated date as $dtCalculatedRecommended
		Set the recommendation Earliest Forecast Date for $r to $dtCalculatedEarliest
		Set the recommendation Recommended Forecast Date for $r to $dtCalculatedRecommended
		Include the Recommendation $r for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
		Log that this Series Rule fired for the Series $targetSeries
		Log Debugging Information about Object Named "mostRecentShot" and Value $mostRecentShot
end

rule "COVID-19(Sep2023+ >= 5yrs): For the 2023-2024 season, the minimum interval and recommended interval from dose 1 to dose 2 are, respectively, to 4m and 4m (*earliestIntevalCheck*)"
	extends "COVID-19(Sep2023+ >= 5yrs): For the 2023-2024 season, the minimum interval and recommended interval from dose 1 to dose 2 are, respectively, to 4m and 4m (*recommendationIntervalCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "earliestIntervalCheck"
	// Since this rule is essentially a table-based rule, run this rule after all other custom rules
	salience -1
	when
		// Conditions checked in parent rule; no additional conditions to check	
	then
		// Nothing to do; earliest forecast date set in parent rule
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
	   Log that this Series Rule fired for the Series $targetSeries
end

/////////////////////
// If the patient has >= 1 COVID-19 shot(s) on record prior to target dose 1 (DC: should this be "target dose 1" or "dose 1"?), evaluate and recommend using the following intervals from the last shot, if none of the following exceptions apply: 
//    Absolute Minimum Interval = 8 weeks - 4 days
//    Minimum Interval = 8 weeks
//    Recommended Interval = 8 weeks
/////////////////////

rule "COVID-19(Sep2023+ >= 5yrs): If the patient has >= 1 COVID-19 shot(s) on record prior to dose 1, the recommended earliest & recommended interval is 8w from target dose 1 to the next target dose IF none of the exceptions apply (*recommendationIntervalCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "recommendationIntervalCheck"
	// This rule overrides the default series recommendation interval rules for 2023-2024, above
	salience 10
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023gte5Series"
			- the effective dose number in the series is == 1
			- the Series is not complete
		There is an administered shot $mostRecentShot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- make note of the date this shot was administered as $mostRecentShotDate
			- the shot is not ignored
		There does not exist an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is > $mostRecentShotDate
			- the shot is not ignored
		//There does not exist an IceFact
		//	- that has associated series $targetSeries
		//	- that has associated administered shot $mostRecentShot
		//	- that has finding a member of ("COVID19_SEPT2023GTE5SERIES_EXCEPTION_2_FOR_TARGET_DOSE_1", "COVID19_SEPT2023GTE5SERIES_EXCEPTION_3_FOR_TARGET_DOSE_1")
		There does not exist an IceIntervalFact
			- that has IceIntervalFact type IntervalFactType.RECOMMENDED
			- that has IceIntervalFact finding SupportedFactConcept._DOSE_INTERVAL_OVERRIDE.conceptCodeValue
			- that has IceIntervalFact current administered shot $mostRecentShot
	then
		Insert a Recommendation IceIntervalFact SupportedFactConcept._DOSE_INTERVAL_OVERRIDE.conceptCodeValue with TargetDose $mostRecentShot into working memory 
		Create a Recommendation as $r for the Series $targetSeries
		Add "8w" to $mostRecentShotDate and make note of the newly calculated date as $dtCalculated
		Set the recommendation Earliest Forecast Date for $r to $dtCalculated
		Set the recommendation Recommended Forecast Date for $r to $dtCalculated
		Include the Recommendation $r for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
	   	Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ >= 5yrs): If the patient has >= 1 COVID-19 shot(s) on record prior to dose 1, the recommended earliest & recommended interval is 8w from target dose 1 to the next target dose IF none of the exceptions apply (*earliestIntervalCheck*)"
	extends "COVID-19(Sep2023+ >= 5yrs): If the patient has >= 1 COVID-19 shot(s) on record prior to dose 1, the recommended earliest & recommended interval is 8w from target dose 1 to the next target dose IF none of the exceptions apply (*recommendationIntervalCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "earliestIntervalCheck"
	// This rule overrides the default series recommendation interval rules for 2023-2024, above
	salience 10
	when
		// No condition required for this extension
	then
		// Nothing to do - earliest interval was specified in the parent rule
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
		   Log that this Series Rule fired for the Series $targetSeries
end


///////
// "If the patient is >= 5 years of age as of the evaluation date, and the elapsed interval from the prior shot is < the date on which the patient turns age 5 years, the recommendation date the recommended interval after the last shot administered (and not at age 5 years)."
// NOTE / AI: This logic as specified on the wiki spe to follow series table interval (4 months), but this is dose 1; 8 weeks seems more correct
///////

rule "COVID-19(Sep2023+ >= 5yrs): If the interval from the most recent shot administered >= the season start date has elapsed and the patient also turns 5 years of age >= season start date, set the recommended age for target dose 1 to the season start date (*recommendationAgeCheck*)" 
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "recommendationAgeCheck"
	when
		// Series Table Recommended Age will be overridden by this rule and not be enforced
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023gte5Series"
			- the effective dose number in the series is == 1
			- the Series is not complete
			- make note of the season start date as $seasonStartDate
		There is an administered shot $mostRecentShot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- make note of the date this shot was administered as $mostRecentShotDate
			- the date $mostRecentShotDate >= $seasonStartDate
			- the shot is not ignored
			- make note of the recommended interval from this dose to the next dose as $recommendedInterval
		There does not exist an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is > $mostRecentShotDate
			- the shot is not ignored
		The patient information $oEvaluatedPerson must be known to complete writing this rule
			- make note of the date as $dtDateAtAge5y when the patient is "5y" of age
			- the date $dtDateAtAge5y >= $seasonStartDate
		There exists an administered shot
			- that is the same shot as $mostRecentShot
			- the administration date of the shot is < $dtDateAtAge5y
		Confirm elapsed time between $mostRecentShotDate and evalTime > $recommendedInterval
	then
		Create a Recommendation as $r for the Series $targetSeries
		// Set the earliest date here to avoid redundant calculation in child earliestAgeCheck rule (below)
		Set the recommendation Earliest Forecast Date for $r to $seasonStartDate
		Set the recommendation Recommended Forecast Date for $r to $seasonStartDate
		Include the Recommendation $r for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
		Log that this Series Rule fired for the Series $targetSeries
	end


rule "COVID-19(Sep2023+ >= 5yrs): If 8 weeks from the last administered shot elapsed prior to the patient turning 5 years of age, set earliest and recommended age for target dose 1 to the season start date (*earliestAgeCheck*)"
	extends "COVID-19(Sep2023+ >= 5yrs): If the interval from the most recent shot administered >= the season start date has elapsed and the patient also turns 5 years of age >= season start date, set the recommended age for target dose 1 to the season start date (*recommendationAgeCheck*)"
	// previously, rule was: "...set earliest and recommended age for target dose 1 to 8w from the last administered shot (*earliestAgeCheck*)", not to 9/12/2023
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "earliestAgeCheck"
	when
		// Series Table Earliest Age will be overridden by this rule and will not be enforced
	then
		// Nothing to do; earliest forecast date set in parent rule
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
	   	Log that this Series Rule fired for the Series $targetSeries
	end

///////
// END If the interval from the most recent shot administered >= 9/12/2023 has elapsed and the patient turns 5 years of age >= 9/23/2023, set the recommended age for target dose 1 to 9/12/2023
///////


// rule "COVID-19(Sep2023 >= 5yrs): If there are no shots in the current season and only ignored shots in the prior season, set the earlest and recommended age date to 9/12/2023 (*recommendationAgeCheck*)"
rule "COVID-19(Sep2023+ >= 5yrs)->TargetDose 1: If there are no shots in the current season but there are shots in a prior season, set the earlest and recommended date for target dose 1 to the latter of age 6 months or the season start date (*recommendationAgeCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "recommendationAgeCheck"
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023gte5Series"
			- the effective dose number in the series is == 1
			- the Series is not complete
			- make note of the season start date as $seasonStartDate
		There is an administered shot $mostRecentShot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- make note of the date this shot was administered as $mostRecentShotDate
			- the administration date of the shot is < $seasonStartDate
		There does not exist an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is < $seasonStartDate
			- the administration date of the shot is > $mostRecentShotDate
		The patient information $oEvaluatedPerson must be known to complete writing this rule
			- make note of the date as $dtDateAtAge6m when the patient is "6m" of age
	then
		Create a Recommendation as $r for the Series $targetSeries
		Set the recommendation Earliest Forecast Date for $r to the latter of $dtDateAtAge6m and $seasonStartDate
		Set the recommendation Recommended Forecast Date for $r to the latter of $dtDateAtAge6m and $seasonStartDate
		Include the Recommendation $r for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
		Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ >= 5yrs): If there are no shots in the current season but there are shots in the prior season, set the earlest and recommended age date to the latter of age 6 months or the season start date (*earliestAgeCheck*)"
		extends "COVID-19(Sep2023+ >= 5yrs)->TargetDose 1: If there are no shots in the current season but there are shots in a prior season, set the earlest and recommended date for target dose 1 to the latter of age 6 months or the season start date (*recommendationAgeCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "earliestAgeCheck"
	when
		// Series Table Recommended Age will be overridden by this rule and will not be enforced
	then
		// Nothing to do; earliest forecast date set in parent rule
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
		Log that this Series Rule fired for the Series $targetSeries
end

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END Recommendation Age / Interval Rules
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Target Dose 1 Evaluation Logic
// 
// If the patient has >= 1 COVID-19 shot(s) on record prior to target dose 1, evaluate and recommend using the following intervals from the last shot, if none of the following exceptions apply: 
//     Absolute Minimum Interval = 8 weeks - 4 days
//     Minimum Interval = 8 weeks
//     Recommended Interval = 8 weeks
//
// Exceptions:
//     Exception 1: If a shot has been ignored (e.g., due to the CVX Code Absolute Maximum Age rule above or due to an inadvertent bivalent shot administered in the previous season), there is no absolute minimum interval 
//         from the ignored shot to the next target dose and no minimum interval or recommended interval from the ignored shot to the next target dose.
//     Exception 2: If a dose of CVX 313 is administered and it is the only dose on record, target dose 1 is not fulfilled, evaluate as Accepted with reason code VACCINE_NOT_PART_OF_THIS_SERIES.
//         Absolute minimum interval to fulfill target dose 1 = 24 days
//         Minimum interval = 28 days
//         Recommended interval = 28 days. If the patient is < 12 years as of the evaluation date and is < 12 years at the recommended due date), return recommended reason code ADMINISTER_mRNA_VACCINE.
//     Exception 3: If a dose of CVX 211 is administered this season (i.e., between 9/12/23 and 10/3/23), evaluate as Accepted with reason code VACCINE_NOT_PART_OF_THIS_SERIES.
//         Absolute minimum interval to fulfill target dose 1 = 24 days
//         Minimum interval = 28 days
//         Recommended interval = 28 days
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

rule "COVID-19(Sep2023+ >= 5yrs)->TargetDose 1/Exception 2: If a previous shot of CVX 313 administered for target dose 1 was determined to be COVID19_INVALID_CVX_313_SEPT2023GTE5SERIES_OTHERWISE_WOULD_BE_CONSIDERED_VALID_FOR_TARGET_DOSE_1, the recommended interval to the next dose is 28 days"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	/////// activation-group "recommendationIntervalCheck"
	salience 20
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023gte5Series"
			- the effective dose number in the series is == 1
			- the Series is not complete
		There is an IceFact $iceFactCVX313NotValid
			- that has associated series $targetSeries
			- that has finding "COVID19_INVALID_CVX_313_SEPT2023GTE5SERIES_OTHERWISE_WOULD_BE_CONSIDERED_VALID_FOR_TARGET_DOSE_1"
			- make note of the associated administered shot as $associatedAdministeredShot
			- make note of the date the associated shot was administered as $cvx313administrationDate
		There does not exist an IceFact
			- that has associated series $targetSeries
			- that has finding "COVID19_INVALID_CVX_313_SEPT2023GTE5SERIES_OTHERWISE_WOULD_BE_CONSIDERED_VALID_FOR_TARGET_DOSE_1"
			- that has associated administered shot date > $cvx313administrationDate
	then
		Insert a Recommendation IceIntervalFact SupportedFactConcept._DOSE_INTERVAL_OVERRIDE.conceptCodeValue with TargetDose $associatedAdministeredShot into working memory 
		Create a Recommendation as $r for the Series $targetSeries
		Add "28d" to $cvx313administrationDate and make note of the newly calculated date as $dtCalculated
		Set the recommendation Earliest Forecast Date for $r to $dtCalculated
		Set the recommendation Recommended Forecast Date for $r to $dtCalculated
		Include the Recommendation $r for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
		Log Debugging Information about Object Named "associatedAdministeredShot" and Value $associatedAdministeredShot
       	Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ >= 5yrs)->TargetDose 1/Exception 2: activation-group extension => If a shot of CVX 313 was previously administered for target dose 1 and evaluated as Accepted / VACCINE_NOT_ALLOWED_FOR_THIS_DOSE, and there are no prior doses on record, the earliest interval from that shot to target dose 1 is 28 days"
		extends "COVID-19(Sep2023+ >= 5yrs)->TargetDose 1/Exception 2: If a previous shot of CVX 313 administered for target dose 1 was determined to be COVID19_INVALID_CVX_313_SEPT2023GTE5SERIES_OTHERWISE_WOULD_BE_CONSIDERED_VALID_FOR_TARGET_DOSE_1, the recommended interval to the next dose is 28 days"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	/////// activation-group "earliestIntervalCheck"
	salience 20
	when
		// No condition required for this extension
	then
		// Nothing to do - earliest interval was specified in the parent rule
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ >= 5yrs)->TargetDose 1/Exception 2: If the patient is < 12y as of the evaluation date and the recommended due date, and the most recent shot was COVID19_INVALID_CVX_313_SEPT2023GTE5SERIES_OTHERWISE_WOULD_BE_CONSIDERED_VALID_FOR_TARGET_DOSE_1, return recommended reason code ADMINISTER_mRNA_VACCINE"
	dialect "mvel"
	agenda-group "RecommendationForecast^postCustomRecommendationCheck^COVID19Sep2023Season"
	salience 20
	when
		There is a Series $targetSeries
			- a forecast for the Series has been made and a recommendation date has been determined
			- the Series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023gte5Series"
			- the effective dose number in the series is == 1
			- make note of the recommendation date as $recommendationDate
			- post processing on the Series forecast has not already been run
		There is an IceFact $iceFactCVX313NotValid
			- that has associated series $targetSeries
			- that has finding "COVID19_INVALID_CVX_313_SEPT2023GTE5SERIES_OTHERWISE_WOULD_BE_CONSIDERED_VALID_FOR_TARGET_DOSE_1"
			- make note of the date the associated shot was administered as $cvx313administrationDate	
		The Patient information $patientInfo must be known to complete writing this rule
			- make note of the Patient's birthdate as $birthDate
		Confirm elapsed time between $birthDate and evalTime < "12y" && elapsed time between $birthDate and $recommendationDate < "12y"
	then
		Create a Recommendation as $recommendation for the Series $targetSeries
		Set the Recommendation Reason for $recommendation to "RECOMMENDATION_REASON_CONCEPT.ADMINISTER_mRNA_VACCINE"
		Include the Recommendation $recommendation for Consideration in the final Forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ >= 5yrs)->TargetDose 1/Exception 3: If a shot of CVX 211 was previously administered for target dose 1 and evaluated as Accepted, the recommended interval from that shot to target dose 1 is 28 days"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	salience 20
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023gte5Series"
			- the number of doses administered is == 0
			- the Series is not complete
		There is an administered shot $shotOfInterest
			- the shot belongs to the Series $targetSeries
			- the dose number in the series is == 1
			- the vaccine administered is "ICE211"
			- that has already been evaluated and whose shot validity is ACCEPTED
			- make note of the date this shot was administered as $cvx211administrationDate
			- make note of Accepted evaluation reasons for this shot as $acceptedReasons
			- the collection $acceptedReasons contains "EVALUATION_REASON_CONCEPT.VACCINE_NOT_PART_OF_THIS_SERIES" 
			- make note of the date this shot was administered as $previousShotDate
	then
		// Recommendations set in decedent rules
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ >= 5yrs)->TargetDose 1/Exception 3: There are no other shots administered after the CVX 211; _also_ override default recommendationIntervalCheck"
		extends "COVID-19(Sep2023+ >= 5yrs)->TargetDose 1/Exception 3: If a shot of CVX 211 was previously administered for target dose 1 and evaluated as Accepted, the recommended interval from that shot to target dose 1 is 28 days"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	/////// activation-group "recommendationIntervalCheck"
	salience 20
	no-loop true
	when
		There does not exist an administered shot
			- the shot belongs to the Series $targetSeries
			- the administration date of the shot is >= $cvx211administrationDate
			- the vaccine administered is not "ICE211"
	then
		Insert a Recommendation IceIntervalFact SupportedFactConcept._DOSE_INTERVAL_OVERRIDE.conceptCodeValue with TargetDose $shotOfInterest into working memory 
		Create a Recommendation as $r for the Series $targetSeries
		Add "28d" to $previousShotDate and make note of the newly calculated date as $dtCalculated
		Set the recommendation Earliest Forecast Date for $r to $dtCalculated
		Set the recommendation Recommended Forecast Date for $r to $dtCalculated
		Include the Recommendation $r for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ >= 5yrs)->TargetDose 1/Exception 3: There are no other shots administered after the CVX 211; _also_ override default earliestIntervalCheck"
		extends "COVID-19(Sep2023+ >= 5yrs)->TargetDose 1/Exception 3: There are no other shots administered after the CVX 211; _also_ override default recommendationIntervalCheck"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	/////// activation-group "earliestIntervalCheck"
	salience 20
	when
		// No additional checks needed
	then
		// Nothing to do as this was set in the recommendationInterval rule; simply overriding default doseIntervalRule
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END TargetDose 1: Exception Rules
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// TargetDose 2: the recommended date is the latter of the calculated forecast date or February 28, 2024.
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

rule "COVID-19(Sep2023+ >= 5yrs): The recommended age of dose 2 is the latter of age 65 years or 2/28/2024 (*recommendationAgeCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "recommendationAgeCheck"
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023gte5Series"
			- the Series belongs to the season with name "COVID19Sep2023Season"
			- the effective dose number in the series is == 2
			- the Series is not complete
		The patient information $oEvaluatedPerson must be known to complete writing this rule
        	- make note of the date as $dtDateAtAge65y when the patient is "65y" of age
	then
		Create a Recommendation as $r for the Series $targetSeries
		Set the recommendation Earliest Forecast Date for $r to the latter of $dtDateAtAge65y and "28-Feb-2024"
		Set the recommendation Recommended Forecast Date for $r to the latter of $dtDateAtAge65y and "28-Feb-2024"
		Include the Recommendation $r for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ >= 5yrs): If there are no shots administered, set the earliest age to the latter of age 65 years or 2/28/2024 (*earliestAgeCheck*)"
		extends "COVID-19(Sep2023+ >= 5yrs): The recommended age of dose 2 is the latter of age 65 years or 2/28/2024 (*recommendationAgeCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "earliestAgeCheck"
when
		// Series Table Earliest Age will be overridden by this rule and will not be enforced
	then
		// Nothing to do; earliest forecast date set in parent rule
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ >= 5ys): If the recommendation date for dose 2 is >= 1 year from the evaluation date, recommendation is NOT_RECOMMENDED / COMPLETE"
	dialect "mvel"
	agenda-group "RecommendationForecast^postCustomRecommendationCheck^COVID19Sep2023Season"
	when
		There is a Series $targetSeries
			- a forecast for the Series has been made and a recommendation date has been determined
			- the Series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023gte5Series"
			- the effective dose number in the Series is == 2
			- make note of the recommendation date as $recommendationDate
			- post processing on the Series forecast has not already been run
		The Patient information $patientInfo must be known to complete writing this rule
			- make note of the Patient's birthdate as $birthDate
		Confirm the date evalTime is before $recommendationDate && elapsed time between evalTime and $recommendationDate >= "1y"
	then
		Create a Recommendation as $recommendation with Status RecommendationStatus.NOT_RECOMMENDED for the Series $targetSeries
		Set the Recommendation Reason for $recommendation to "RECOMMENDATION_REASON_CONCEPT.COMPLETE"
		Include the Recommendation $recommendation for Consideration in the final Forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END TargetDose 2: the recommended date is the latter of the calculated forecast date or February 28, 2024.
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/*****************************************************************************************************************************************************************************************************************
 END Series: >= 5 yrs: Recommendation Interval / Interval Rules
*****************************************************************************************************************************************************************************************************************/



/*****************************************************************************************************************************************************************************************************************
 ===> Series: Pfizer < 5 yrs
*****************************************************************************************************************************************************************************************************************/

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Interval from a Prior Formulation or Non-Pfizer Vaccine
//    If a prior formulation COVID-19 vaccine (excluding non-US vaccines that do not count towards U.S. vaccination) or a non-Pfizer updated seasonal COVID-19 vaccine is administered as target dose 1 or target dose 2, intervals to the next target dose are: 
//        Absolute minimum interval = 24 days
//        Minimum interval = 28 days
//        Recommended interval = 28 days
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

rule "COVID-19(Sep2023+ Pfizer < 5yrs Series): If a prior formulation COVID-19 vaccine (excluding non-US vaccines that do not count towards US vaccination) or a non-Pfizer updated seasonal COVID-19 vaccine is administered on or after 9/12/2023 for target dose 1 or target dose 2, the minimum/recommended interval to the next dose is 28 days(*recommendationIntervalCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "recommendationIntervalCheck"
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023PfizerLT5ySeries"
			- the effective dose number in the Series is <= 2
			- the Series is not complete
		There is an administered shot $mostRecentShot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is >= "12-Sep-2023"
			- the vaccine administered a member of ("ICE207", "ICE208", "ICE210", "ICE211", "ICE212", "ICE213", "ICE217", "ICE218", "ICE219", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE311", "ICE312", "ICE313", "ICE520")
			- the shot is not ignored
			- make note of the date this shot was administered as $mostRecentShotDate
		There does not exist an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is > $mostRecentShotDate
			- the shot is not ignored
	then
		Create a Recommendation as $r for the Series $targetSeries
		Add "28d" to $mostRecentShotDate and make note of the newly calculated date as $dtCalculated
		Set the recommendation Earliest Forecast Date for $r to $dtCalculated
		Set the recommendation Recommended Forecast Date for $r to $dtCalculated
		Include the Recommendation $r for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ Pfizer < 5yrs Series): If a prior formulation COVID-19 vaccine (excluding non-US vaccines that do not count towards US vaccination) or a non-Pfizer updated seasonal COVID-19 vaccine is administered as target dose 1 or target dose 2, the minimum/recommended interval to the next dose is 28 days(*earliestIntervalCheck*)"
		extends "COVID-19(Sep2023+ Pfizer < 5yrs Series): If a prior formulation COVID-19 vaccine (excluding non-US vaccines that do not count towards US vaccination) or a non-Pfizer updated seasonal COVID-19 vaccine is administered on or after 9/12/2023 for target dose 1 or target dose 2, the minimum/recommended interval to the next dose is 28 days(*recommendationIntervalCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "earliestIntervalCheck"
	when
		// Series Table Earliest Age will be overridden by this rule and will not be enforced
	then
		// Nothing to do; earliest forecast date set in parent rule
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end	
	
	
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// ===> Pfizer < 5 yrs Series  
// If a shot is administered below the series absolute minimum age (< 6m - 4 days) in this season (on or after 9/12/2023):
// If administered as target dose 1 or target dose 2, intervals to the next target dose are:  
//    Absolute minimum interval = 24 days
//    Minimum interval = 28 days
//    Recommended interval = 28 days 
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

rule "COVID-19(Sep2023+ Pfizer < 5yrs Series): If a shot was previously administered for target dose 1 or target dose 2 and evaluated as Invalid / BELOW_MINIMUM_AGE_SERIES and the series is not complete, the minimum/recommended interval from that shot to the next shot is 28 days (*recommendationIntervalCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "recommendationIntervalCheck"
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023PfizerLT5ySeries"
			- the Series is not complete
			- the effective dose number in the Series is <= 2
		There is an administered shot $mostRecentShot
			- the shot belongs to the series $targetSeries
			- make note of the date this shot was administered as $mostRecentShotDate
			- the shot is not ignored
		There does not exist an administered shot
			- the shot belongs to the series $targetSeries
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is > $mostRecentShotDate
			- the shot is not ignored
		There exists an IceFact
			- that has associated administered shot $mostRecentShot
			- that has finding SupportedFactConcept._BELOW_MINIMUM_AGE.conceptCodeValue 
	then
		Create a Recommendation as $r for the Series $targetSeries
		Add "28d" to $mostRecentShotDate and make note of the newly calculated date as $dtCalculated
		Set the recommendation Earliest Forecast Date for $r to $dtCalculated
		Set the recommendation Recommended Forecast Date for $r to $dtCalculated
		Include the Recommendation $r for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end

rule "COVID-19(Sep2023+ Pfizer < 5yrs Series): If a shot was previously administered for target dose 1 or target dose 2 and evaluated as Invalid / BELOW_MINIMUM_AGE_SERIES and the series is not complete, the minimum/recommended interval from that shot to the next shot is 28 days (*earliestIntervalCheck*)"
		extends "COVID-19(Sep2023+ Pfizer < 5yrs Series): If a shot was previously administered for target dose 1 or target dose 2 and evaluated as Invalid / BELOW_MINIMUM_AGE_SERIES and the series is not complete, the minimum/recommended interval from that shot to the next shot is 28 days (*recommendationIntervalCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "earliestIntervalCheck"
	when
		// Series Table Earliest Age will be overridden by this rule and will not be enforced
	then
		// Nothing to do; earliest forecast date set in parent rule
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end

/*****************************************************************************************************************************************************************************************************************
 END Series: Pfizer < 5 yrs
*****************************************************************************************************************************************************************************************************************/




/*****************************************************************************************************************************************************************************************************************
 ===> Series: Moderna < 5 yrs
*****************************************************************************************************************************************************************************************************************/

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// ===> Moderna < 5 yrs Series
// If a shot is administered below the series absolute minimum age (< 6m - 4 days) in this season (on or after 9/12/2023) , intervals to the next target dose are:  
//    Absolute minimum interval = 24 days
//    Minimum interval = 28 days
//    Recommended interval = 28 days 
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

rule "COVID-19(Sep2023+ Moderna < 5yrs Series): If a shot was previously administered for target dose 1 or target dose 2 and evaluated as Invalid / BELOW_MINIMUM_AGE_SERIES and the series is not complete, the minimum/recommended interval from that shot to the next shot is 28 days (*recommendationIntervalCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "recommendationIntervalCheck"
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023ModernaLT5ySeries"
			- the Series is not complete
		There is an administered shot $mostRecentShot
			- the shot belongs to the series $targetSeries
			- make note of the date this shot was administered as $mostRecentShotDate
			- the shot is not ignored
		There does not exist an administered shot
			- the shot belongs to the series $targetSeries
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is > $mostRecentShotDate
			- the shot is not ignored
		There exists an IceFact
			- that has associated administered shot $mostRecentShot
			- that has finding SupportedFactConcept._BELOW_MINIMUM_AGE.conceptCodeValue 
	then
		Create a Recommendation as $r for the Series $targetSeries
		Add "28d" to $mostRecentShotDate and make note of the newly calculated date as $dtCalculated
		Set the recommendation Earliest Forecast Date for $r to $dtCalculated
		Set the recommendation Recommended Forecast Date for $r to $dtCalculated
		Include the Recommendation $r for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end

rule "COVID-19(Sep2023+ Moderna < 5yrs Series): If a shot was previously administered for target dose 1 or target dose 2 and evaluated as Invalid / BELOW_MINIMUM_AGE_SERIES and the series is not complete, the minimum/recommended interval from that shot to the next shot is 28 days (*earliestIntervalCheck*)"
		extends "COVID-19(Sep2023+ Moderna < 5yrs Series): If a shot was previously administered for target dose 1 or target dose 2 and evaluated as Invalid / BELOW_MINIMUM_AGE_SERIES and the series is not complete, the minimum/recommended interval from that shot to the next shot is 28 days (*recommendationIntervalCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "earliestIntervalCheck"
when
		// Series Table Earliest Age will be overridden by this rule and will not be enforced
	then
		// Nothing to do; earliest forecast date set in parent rule
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end

/*****************************************************************************************************************************************************************************************************************
 END Series: Moderna < 5 yrs
*****************************************************************************************************************************************************************************************************************/




/*****************************************************************************************************************************************************************************************************************
 ===> Series: Mixed Product < 5 yrs
*****************************************************************************************************************************************************************************************************************/

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// ===> Mixed Product < 5 yrs Series
// If a shot is administered below the series absolute minimum age (< 6m - 4 days) in this season (on or after 9/12/2023):  
//    If administered as target dose 1 or target dose 2, intervals to the next target dose are:  
//        Absolute minimum interval = 24 days
//        Minimum interval = 28 days
//        Recommended interval = 28 days 
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

rule "COVID-19(Sep2023+ Mixed Product < 5yrs Series): If a shot was previously administered for target dose 1 or target dose 2 and evaluated as Invalid / BELOW_MINIMUM_AGE_SERIES and the series is not complete, the minimum/recommended interval from that shot to the next shot is 28 days (*recommendationIntervalCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "recommendationIntervalCheck"
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023MixedProductLT5ySeries"
			- the Series is not complete
			- the effective number of doses administered in the Series is <= 2
		There is an administered shot $mostRecentShot
			- the shot belongs to the series $targetSeries
			- make note of the date this shot was administered as $mostRecentShotDate
			- the shot is not ignored
		There does not exist an administered shot
			- the shot belongs to the series $targetSeries
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is > $mostRecentShotDate
			- the shot is not ignored
		There exists an IceFact
			- that has associated administered shot $mostRecentShot
			- that has finding SupportedFactConcept._BELOW_MINIMUM_AGE.conceptCodeValue 
	then
		Create a Recommendation as $r for the Series $targetSeries
		Add "28d" to $mostRecentShotDate and make note of the newly calculated date as $dtCalculated
		Set the recommendation Earliest Forecast Date for $r to $dtCalculated
		Set the recommendation Recommended Forecast Date for $r to $dtCalculated
		Include the Recommendation $r for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end

rule "COVID-19(Sep2023+ Mixed Product < 5yrs Series): If a shot was previously administered for target dose 1 or target dose 2 and evaluated as Invalid / BELOW_MINIMUM_AGE_SERIES and the series is not complete, the minimum/recommended interval from that shot to the next shot is 28 days (*earliestIntervalCheck*)"
		extends "COVID-19(Sep2023+ Mixed Product < 5yrs Series): If a shot was previously administered for target dose 1 or target dose 2 and evaluated as Invalid / BELOW_MINIMUM_AGE_SERIES and the series is not complete, the minimum/recommended interval from that shot to the next shot is 28 days (*recommendationIntervalCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "earliestIntervalCheck"
when
		// Series Table Earliest Age will be overridden by this rule and will not be enforced
	then
		// Nothing to do; earliest forecast date set in parent rule
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// If the most recent dose administered was a Novavax (CVX 313) to a patient age >= 6 months - 4 days and < 5 years and the patient is not complete for a Sept 2023 COVID-19 series, return recommended reason code ADMINISTER_mRNA_VACCINE.
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

rule "COVID-19(Sep2023+ Mixed Product < 5yrs Series): If the most recent shot administered was a Novavax (CVX 313) to a patient age >= 6m-4d and < 5 yrs and the series is not complete, return recommended reason code ADMINISTER_mRNA_VACCINE"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023MixedProductLT5ySeries"
			- the Series is not complete
			- make note of the last shot administered in the Series as $lastShotAdministered
		There is an administered shot $sameShot
			- that is the same shot as $lastShotAdministered
			- the vaccine administered is "ICE313"
			- make note of the minimum vaccine age for this shot as $absMinVaccineAge
			- make note of the date this shot was administered as $shotAdministrationDate
		The patient information $patient must be known to complete writing this rule
			- make note of the patient's birthdate as $birthDate
		Confirm elapsed time between $birthDate and $shotAdministrationDate >= $absMinVaccineAge
		Confirm elapsed time between $birthDate and $shotAdministrationDate < "5y"
	then
		Create a Recommendation as $recommendation for the Series $targetSeries
		Set the Recommendation Reason for $recommendation to "RECOMMENDATION_REASON_CONCEPT.ADMINISTER_mRNA_VACCINE"
		Include the Recommendation $recommendation for Consideration in the final Forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end

/*****************************************************************************************************************************************************************************************************************
END Series: Mixed Product < 5 yrs
*****************************************************************************************************************************************************************************************************************/




/*************************************************************************************************************************************************************************************
===> Series: Sep2023+ Novavax
/************************************************************************************************************************************************************************************/

/////////////////////
// In the 2023-2024 season, the absolute minimum interval (see evaluation rules), minimum interval and recommended interval from dose 3 to dose 4 are, respectively, 8w-4d, 8w and 6m.
// Absolute minimum interval rule is in this rule file; recommended interval rules are in the recommendation rule file.
// This overrides the value set in the series table, which is set for the latest season. 
/////////////////////

rule "COVID-19(Sep2023+ Novavax Series): For the 2023-2024 season, the minimum interval and recommended interval from dose 3 to dose 4 are, respectively, to 4m and 4m (*recommendationIntervalCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "recommendationIntervalCheck"
	// Since this rule is essentially a table-based rule, run this rule after all other custom rules
	salience -1
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the name of the series is "COVID19Sep2023NovavaxSeries"
			- the Series belongs to the Season with name "COVID19Sep2023Season"
			- the Series is not Complete
			- the effective dose number in the Series is == 4
		There is an administered shot $lastUnignoredShot
			- the shot belongs to the Series $targetSeries
			- the shot is not ignored
			- make note of the date this shot was administered as $mostRecentShotDate
		There does not exist an administered shot
			- the shot belongs to the Series $targetSeries
			- the administration date of the shot is > $mostRecentShotDate
			- the shot is not ignored
	then
		Create a Recommendation as $r for the Series $targetSeries
		Add "4m" to $mostRecentShotDate and make note of the newly calculated date as $dtCalculatedEarliest
		Add "4m" to $mostRecentShotDate and make note of the newly calculated date as $dtCalculatedRecommended
		Set the recommendation Earliest Forecast Date for $r to $dtCalculatedEarliest
		Set the recommendation Recommended Forecast Date for $r to $dtCalculatedRecommended
		Include the Recommendation $r for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end

rule "COVID-19(Sep2023+ Novavax Series): For the 2023-2024 season, the minimum interval and recommended interval from dose 3 to dose 4 are, respectively, to 4m and 4m (*earliestIntevalCheck*)"
		extends "COVID-19(Sep2023+ Novavax Series): For the 2023-2024 season, the minimum interval and recommended interval from dose 3 to dose 4 are, respectively, to 4m and 4m (*recommendationIntervalCheck*)"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "earliestIntervalCheck"
	// Since this rule is essentially a table-based rule, run this rule after all other custom rules 
	salience -1
	when
		// Conditions checked in parent rule; no additional conditions to check	
	then
		// Nothing to do; earliest forecast date set in parent rule
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// If the patient is age >= 5 years and < 12-4d years and CVX 313 is administered as dose 1, evaluate and recommend using the following intervals:  
//     Minimum Interval = 4 weeks
//     Recommended Interval = 4 weeks. 
// Furthermore, if the patient is < 12 years as of the evaluation date and is < 12 years at the recommended due date), return recommended reason code ADMINISTER_mRNA_VACCINE.
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

rule "COVID-19(Sep2023+ Novavax Series): If a CVX 313 is administered as (valid) dose 1 to a patient >= 5 yrs and < 12 yrs-4 days, recommend earliest/recommended interval of 4 weeks from dose 1"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "recommendationAgeCheck"
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023NovavaxSeries"
			- the number of administered shots is >= 1
			- the effective number of doses administered in the Series is == 1
			- Make note of the last shot administered in the Series as $lastShotAdministered
		There is an administered shot $CVX313Dose1
			- the shot belongs to the Series $targetSeries
			- the vaccine administered is "ICE313"
			- that has already been evaluated and whose shot validity is VALID
			- the dose number in the series is == 1
		There is an administered shot $mostRecentShot
			- that is the same shot as $lastShotAdministered
			- make note of the date this shot was administered as $lastShotAdministrationDate
		The patient information $oEvaluatedPerson must be known to complete writing this rule
        	- make note of the patient's birthdate as $dtBirthDate
        Confirm elapsed time between $dtBirthDate and $lastShotAdministrationDate >= "5y"
        Confirm elapsed time between $dtBirthDate and $lastShotAdministrationDate < "12y-4d"
	then
		Create a Recommendation as $r for the Series $targetSeries
		Add "4w" to $lastShotAdministrationDate and make note of the newly calculated date as $dtCalculatedMinimum
		Add "4w" to $lastShotAdministrationDate and make note of the newly calculated date as $dtCalculatedRecommended
		Set the recommendation Earliest Forecast Date for $r to $dtCalculatedMinimum
		Set the recommendation Recommended Forecast Date for $r to $dtCalculatedRecommended
		Include the Recommendation $r for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ Novavax Series):activation-group extension => If a CVX 313 is administered as (valid) dose 1 to a patient >= 5 yrs and < 12 yrs, recommend earliest/recommended interval of 4 weeks from dose 1"
		extends "COVID-19(Sep2023+ Novavax Series): If a CVX 313 is administered as (valid) dose 1 to a patient >= 5 yrs and < 12 yrs-4 days, recommend earliest/recommended interval of 4 weeks from dose 1"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "earliestAgeCheck"
	when
		// No condition required for this extension
	then
		// Nothing to do; earliest forecast date set in parent rule
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ Novavax Series): If the patient is < 12 years as of the evaluation date and is < 12 years at the recommended due date), return recommended reason code ADMINISTER_mRNA_VACCINE."
	dialect "mvel"
	agenda-group "RecommendationForecast^postCustomRecommendationCheck^COVID19Sep2023Season"
	when
		There is a Series $targetSeries
			- a forecast for the Series has been made and a recommendation date has been determined
			- the Series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023NovavaxSeries"
			- make note of the recommendation date as $recommendationDate
			- post processing on the Series forecast has not already been run
		The Patient information $patientInfo must be known to complete writing this rule
			- make note of the Patient's birthdate as $birthDate
		Confirm elapsed time between $birthDate and evalTime < "12y" && elapsed time between $birthDate and $recommendationDate < "12y"
	then
		Create a Recommendation as $recommendation for the Series $targetSeries
		Set the Recommendation Reason for $recommendation to "RECOMMENDATION_REASON_CONCEPT.ADMINISTER_mRNA_VACCINE"
		Include the Recommendation $recommendation for Consideration in the final Forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end	


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// For target dose 4, if the recommendation date is >= 1 year from the evaluation date, recommendation is NOT_RECOMMENDED / COMPLETE
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rule "COVID-19(Sep2023+ Novavax Series): If the recommendation date for dose 4 is >= 1 year from the evaluation date, recommendation is NOT_RECOMMENDED / COMPLETE"
	dialect "mvel"
	agenda-group "RecommendationForecast^postCustomRecommendationCheck^COVID19Sep2023Season"
	when
		There is a Series $targetSeries
			- a forecast for the Series has been made and a recommendation date has been determined
			- the Series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023NovavaxSeries"
			- the effective dose number in the Series is == 4
			- make note of the recommendation date as $recommendationDate
			- post processing on the Series forecast has not already been run
		The Patient information $patientInfo must be known to complete writing this rule
			- make note of the Patient's birthdate as $birthDate
		Confirm the date evalTime is before $recommendationDate && elapsed time between evalTime and $recommendationDate >= "1y"
	then
		Create a Recommendation as $recommendation with Status RecommendationStatus.NOT_RECOMMENDED for the Series $targetSeries
		Set the Recommendation Reason for $recommendation to "RECOMMENDATION_REASON_CONCEPT.COMPLETE"
		Include the Recommendation $recommendation for Consideration in the final Forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// For target dose 4, the recommended date is the later of the calculated forecast date or February 28, 2024.
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rule "COVID-19(Sep2023+ Novavax Series): For target dose 4, the earliest & recommended date is the latter of the calculated forecast date or 2/28/2024"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023NovavaxSeries"
			- the effective dose number in the Series is == 4
			The patient information $oEvaluatedPerson must be known to complete writing this rule
        	- make note of the date as $dtDateAtAge65y when the patient is "65y" of age
	then
		Create a Recommendation as $r for the Series $targetSeries
		Set the recommendation Earliest Forecast Date for $r to the latter of $dtDateAtAge65y and "28-Feb-2024"
		Set the recommendation Recommended Forecast Date for $r to the latter of $dtDateAtAge65y and "28-Feb-2024"
		Include the Recommendation $r for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end

/*************************************************************************************************************************************************************************************
 END ===> Series: Sep2023 Novavax
/************************************************************************************************************************************************************************************/



/*****************************************************************************************************************************************************************************************************************
 ===> Intervals from PRIOR Season ; v1.42 release logic, still applicable
 ===> Series: >= 5 yrs, Pfizer < 5 yrs, Moderna < 5 yrs or Mixed Product < 5 yrs
   If a prior formulation is administered for target dose 1, recommend interval of 28 days to the next dose  (See above)
 Otherwise:
 If the patient has >= 1 COVID-19 shot(s) on record prior to (a valid) dose 1, recommend using the following intervals from the last shot in the  
   >= 5 yrs, Pfizer < 5 yrs, Moderna < 5 yrs or Mixed Product < 5 yrs series.
     + Minimum Interval = 8 weeks
     + Recommended Interval = 8 weeks
*****************************************************************************************************************************************************************************************************************/

rule "COVID-19(Sep2023+ Pfizer/Moderna/Mixed Product < 5yrs): For target dose 1 of the current series' season: shot(s) have been administered in the current season and there are also shots in a prior season but none of them are (valid) doses. Recommend earliest/recommended/overdue interval of 8w from the most recent shot in the previous season"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series a member of ("COVID19Sep2023PfizerLT5ySeries", "COVID19Sep2023ModernaLT5ySeries", "COVID19Sep2023MixedProductLT5ySeries")
			- the Series belongs to the Season with name "COVID19Sep2023Season"
			- the Series is not complete
			- the effective dose number in the Series is == 1
			- make note of the season start date as $seasonStartDate
		There does not exist an administered shot
			- the shot belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is < $seasonStartDate 
			- that has already been evaluated and whose shot validity is VALID
		There is an administered shot $previousShot
			- the administration date of the shot is < $seasonStartDate
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the shot is not ignored
			- make note of the date this shot was administered as $previousShotDate
		There does not exist an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is > $previousShotDate
			- the administration date of the shot is < $seasonStartDate
		There exists a Season
			- the name of the Season is "COVID19Aug2024Season"
			- the fully specified season start date is > evalTime
	then
		Create a Recommendation as $r for the Series $targetSeries
		Add "8w" to $previousShotDate and make note of the newly calculated date as $dtCalculated
		Set the recommendation Earliest Forecast Date for $r to $dtCalculated
		Set the recommendation Recommended Forecast Date for $r to $dtCalculated
		Set the recommendation Overdue Forecast Date for $r to $dtCalculated
		Include the Recommendation $r for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ Pfizer/Moderna/Mixed Product < 5yrs Series): For target dose 1 of the current series' season: no shots have been administered in the current season but there have been shots administered in a prior season. Enforce the earliest/recommended recommendation interval for the current series dose from the most recent shot in the prior season"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series a member of ("COVID19Sep2023PfizerLT5ySeries", "COVID19Sep2023MixedProductLT5ySeries", "COVID19Sep2023ModernaLT5ySeries")
			- the Series is not complete
			- the number of administered shots is == 0
			- make note of the effective dose number in the Series as $effectiveDoseNumber
			- the numeric $effectiveDoseNumber is == 1
			- make note of the season start date as $seasonStartDate
		There is an administered shot $mostRecentShotPreviousSeason
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is < $seasonStartDate
			- make note of the date this shot was administered as $mostRecentShotDate
		There does not exist an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is < $seasonStartDate
			- the administration date of the shot is > $mostRecentShotDate
	then
		Obtain the existing DoseRule for Dose Number 1 in the Series $targetSeries as $oDoseRule
		Obtain the Minimum Interval from the existing DoseRule $oDoseRule as $oMinimumInterval
		Obtain the Recommended Interval from the existing DoseRule $oDoseRule as $oRecommendedInterval
		Create a Recommendation as $r for the Series $targetSeries
		Add $oMinimumInterval to $mostRecentShotDate and make note of the newly calculated date as $dtCalculatedMinimum
		Add $oRecommendedInterval to $mostRecentShotDate and make note of the newly calculated date as $dtCalculatedRecommended
		Set the recommendation Earliest Forecast Date for $r to $dtCalculatedMinimum
		Set the recommendation Recommended Forecast Date for $r to $dtCalculatedRecommended
		Include the Recommendation $r for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ Pfizer/Moderna/Mixed Product < 5yrs Series): For target dose > 1: If no shots have been administered in the current season. Enforce the earliest/recommended recommendation interval for the current series dose from the most recent shot in a previous season"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season^CustomIntervals"
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series a member of ("COVID19Sep2023PfizerLT5ySeries", "COVID19Sep2023MixedProductLT5ySeries", "COVID19Sep2023ModernaLT5ySeries")
			- the Series is not complete
			- the number of administered shots is == 0
			- make note of the number of doses required to complete this Series as $numberOfDosesInSeries
			- make note of the effective dose number in the Series as $effectiveDoseNumber
			- the numeric $effectiveDoseNumber is > 1
			- the numeric $effectiveDoseNumber is <= $numberOfDosesInSeries
			- make note of the season start date as $seasonStartDate
		There is an administered shot $mostRecentShotPreviousSeason
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is < $seasonStartDate
			- make note of the date this shot was administered as $mostRecentShotDate
		There does not exist an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is < $seasonStartDate
			- the administration date of the shot is > $mostRecentShotDate
	then
		Obtain the existing DoseRule for Dose Number $effectiveDoseNumber-1 in the Series $targetSeries as $oDoseRule
		Obtain the Minimum Interval from the existing DoseRule $oDoseRule as $oMinimumInterval
		Obtain the Recommended Interval from the existing DoseRule $oDoseRule as $oRecommendedInterval
		/////// Obtain the Latest Recommended Interval from the existing DoseRule $oDoseRule as $oLatestRecommendedInterval
		Create a Recommendation as $r for the Series $targetSeries
		Add $oMinimumInterval to $mostRecentShotDate and make note of the newly calculated date as $dtCalculatedMinimum
		Add $oRecommendedInterval to $mostRecentShotDate and make note of the newly calculated date as $dtCalculatedRecommended
		/////// Add $oLatestRecommendedInterval to $mostRecentShotDate and make note of the newly calculated date as $dtCalculatedRecommendedLatest
		Set the recommendation Earliest Forecast Date for $r to $dtCalculatedMinimum
		Set the recommendation Recommended Forecast Date for $r to $dtCalculatedRecommended
		/////// Set the recommendation Overdue Forecast Date for $r to $dtCalculatedRecommendedLatest
		Include the Recommendation $r for Consideration in the final forecast of the Series
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end


/////////////////////
// If the patient has >= 2 doses of any of the following prior Moderna COVID-19 vaccines (CVX 207, CVX 221, CVX 227, CVX 228, CVX 229, CVX 230, CVX 519) administered before 9/12/2023 
// and there does not exist a shot administered prior to 9/12/2023 at >= 5 years of age, target dose 1 is not needed. Skip to target dose 2. 
//     + Absolute minimum interval = 8 weeks - 4 days
//     + Minimum interval = 8 weeks 
//     + Recommended interval = 8 weeks 
/////////////////////

rule "COVID-19(Sep2023+ __Moderna__ < 5yrs Series): For target dose > 1: If 2 or more doses of the prior Moderna vaccine formulation were administered in the prior season, earliest/recommended interval to the next dose is 8 weeks"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	activation-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season^CustomIntervals"
	no-loop true
	salience 10
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023ModernaLT5ySeries"
			- the Series is not complete
			// - at least one shot has been administered
			- the number of doses administered is == 0
			- the effective dose number in the Series is > 1
			- make note of the season start date as $seasonStartDate
		// Obtain the most recent dose in the prior season
		There is an administered shot $previousShot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is < $seasonStartDate
			- that has already been evaluated and whose shot validity is VALID
			- the vaccine administered a member of ("ICE207", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE311", "ICE312", "ICE519")
			- make note of the date this shot was administered as $mostRecentShotDatePriorSeason
			- make note of the associated series as $priorSeasonSeries
		// We want to run this rule for one and only one dose from the prior season; therefore, make sure we're looking at the most recent dose in that season
		There does not exist an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the shot belongs to the series $priorSeasonSeries
			- the administration date of the shot is < $seasonStartDate
			- the administration date of the shot is > $mostRecentShotDatePriorSeason
			- that has already been evaluated and whose shot validity is VALID
		// Now check to make sure there is a different dose in the prior season in the same series
		There exists an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- that is not the same shot as $previousShot
			- the shot belongs to the series $priorSeasonSeries
			- the administration date of the shot is < $seasonStartDate
			- the administration date of the shot is != $mostRecentShotDatePriorSeason
			- that has already been evaluated and whose shot validity is VALID
	then
		// Create a recommendation of 8 weeks from the prior season's most recent shot
		Create a Recommendation as $r for the Series $targetSeries
		Add "8w" to $mostRecentShotDatePriorSeason and make note of the newly calculated date as $dtCalculatedMinimum
		Add "8w" to $mostRecentShotDatePriorSeason and make note of the newly calculated date as $dtCalculatedRecommended
		Set the recommendation Earliest Forecast Date for $r to $dtCalculatedMinimum
		Set the recommendation Recommended Forecast Date for $r to $dtCalculatedRecommended
		Include the Recommendation $r for Consideration in the final forecast of the Series
		// Now update the DoseRule for dose number 1, in case there are shots in the current season too
		Obtain the existing DoseRule for Dose Number 1 in the Series $targetSeries as $oDoseRule
		Obtain the Minimum Interval from the existing DoseRule $oDoseRule as $oMinimumInterval
		Obtain the Recommended Interval from the existing DoseRule $oDoseRule as $oRecommendedInterval
		Set the Minimum Interval for DoseRule $oDoseRule to TimePeriod "8w"
		Set the Earliest Recommended Interval for DoseRule $oDoseRule to TimePeriod "8w"
		Replace the existing DoseRule in the Series $targetSeries with $oDoseRule
		Refresh all facts in the Series $targetSeries
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
       	Log that this Series Rule fired for the Series $targetSeries
end

/*****************************************************************************************************************************************************************************************************************
 END Recommendation Interval Rules from prior season; Series: >= 5 yrs, Pfizer < 5 yrs, Moderna < 5 yrs or Mixed Product < 5 yrs ; v1.42 release logic, still applicable
*****************************************************************************************************************************************************************************************************************/




/*************************************************************************************************************************************************************************************
 SKIP DOSE RULES
 ===> Series: >= 5 yrs, Pfizer < 5 yrs, Moderna < 5 yrs or Mixed Product < 5 yrs ; v1.42 release logic, still applicable
	 __SKIP DOSE__ Rules FOR < 5 yrs of age series: Pfizer < 5ys, Moderna < 5yrs, Mixed Product < 5yrs; Novavax
     
 ===> Series: Novavax
     + If CVX 313 was administered for dose 1 or dose 2, dose 3 is not needed. Skip to target dose 4. 
/************************************************************************************************************************************************************************************/

rule "COVID-19(Sep2023+ __Pfizer__ < 5yrs Series): if the patient has 1 dose of a prior or current Pfizer vaccine formulation administered prior to the season start date at < 5yrs of age, set the recommendation dose number to 2"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	salience 999
	no-loop true
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023PfizerLT5ySeries"
			- the Series is not complete
			- make note of the effective dose number in the Series as $effectiveDoseNumber
			- the numeric $effectiveDoseNumber is <= 2
			- the dose number to recommend is < 2
			- make note of the season start date as $seasonStartDate
		// Obtain the most recent dose in the prior season
		There is an administered shot $previousShot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			/////// - the administration date of the shot is < "12-Sep-2023"
			- the administration date of the shot is < $seasonStartDate
			- that has already been evaluated and whose shot validity is VALID
			- the vaccine administered a member of ("ICE208", "ICE217", "ICE218", "ICE219", "ICE300", "ICE301", "ICE302", "ICE308", "ICE309", "ICE310", "ICE520")
			- make note of the date this shot was administered as $administrationDate
			- make note of the associated series as $associatedPriorSeasonSeries
		// We want to run this rule for one and only one dose from the prior season; therefore, make sure we're looking at the most recent dose in that season
		There does not exist an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			/////// - the administration date of the shot is < "12-Sep-2023"
			- the administration date of the shot is < $seasonStartDate
			- the administration date of the shot is > $administrationDate
			- that has already been evaluated and whose shot validity is VALID
			- the vaccine administered a member of ("ICE208", "ICE217", "ICE218", "ICE219", "ICE300", "ICE301", "ICE302", "ICE308", "ICE309", "ICE310", "ICE520")
		// Now check to make sure there is not a different dose in the prior season
		There does not exist an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- that is not the same shot as $previousShot
			/////// - the administration date of the shot is < "12-Sep-2023"
			- the administration date of the shot is < $seasonStartDate
			- the administration date of the shot is != $administrationDate
			- that has already been evaluated and whose shot validity is VALID
			- the vaccine administered a member of ("ICE208", "ICE217", "ICE218", "ICE219", "ICE300", "ICE301", "ICE302", "ICE308", "ICE309", "ICE310", "ICE520")
	then
		Skip Series Dose Number to 2 from $effectiveDoseNumber for Disease "SUPPORTED_DISEASE_CONCEPT.079.89" in Series $targetSeries but do not refresh series facts
		Set the Dose Number of Recommendation Forecast to 2 in Series $targetSeries
		Refresh all facts in the Series $targetSeries
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
		Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ __Pfizer__ < 5yrs Series): if the patient has >= 2 doses of a prior or current Pfizer formulation administered prior to the season start date at < 5yrs of age, set the recommendation dose number to 3"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	salience 999
	no-loop true
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023PfizerLT5ySeries"
			- the Series is not complete
			- make note of the effective dose number in the Series as $effectiveDoseNumber
			- the numeric $effectiveDoseNumber is <= 3
			- the dose number to recommend is < 3
			- make note of the season start date as $seasonStartDate
		// Obtain the most recent dose in the prior season
		There is an administered shot $previousShot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			/////// - the administration date of the shot is < "12-Sep-2023"
			- the administration date of the shot is < $seasonStartDate
			- that has already been evaluated and whose shot validity is VALID
			- the vaccine administered a member of ("ICE208", "ICE217", "ICE218", "ICE219", "ICE300", "ICE301", "ICE302", "ICE308", "ICE309", "ICE310", "ICE520")
			- make note of the date this shot was administered as $administrationDate
			- make note of the associated series as $priorSeasonSeries
		// We want to run this rule for one and only one dose from the prior season; therefore, make sure we're looking at the most recent dose in that season
		There does not exist an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the shot belongs to the series $priorSeasonSeries
			/////// - the administration date of the shot is < "12-Sep-2023"
			- the administration date of the shot is < $seasonStartDate
			- the administration date of the shot is > $administrationDate
			- that has already been evaluated and whose shot validity is VALID
			- the vaccine administered a member of ("ICE208", "ICE217", "ICE218", "ICE219", "ICE300", "ICE301", "ICE302", "ICE308", "ICE309", "ICE310", "ICE520")
		// Now check to make sure there is a different dose in the prior season in the same series
		There exists an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- that is not the same shot as $previousShot
			- the shot belongs to the series $priorSeasonSeries
			/////// - the administration date of the shot is < "12-Sep-2023"
			- the administration date of the shot is < $seasonStartDate
			- that has already been evaluated and whose shot validity is VALID
			- the vaccine administered a member of ("ICE208", "ICE217", "ICE218", "ICE219", "ICE300", "ICE301", "ICE302", "ICE308", "ICE309", "ICE310", "ICE520")
	then
		Skip Series Dose Number to 3 from $effectiveDoseNumber for Disease "SUPPORTED_DISEASE_CONCEPT.079.89" in Series $targetSeries but do not refresh series facts
		Set the Dose Number of Recommendation Forecast to 3 in Series $targetSeries
		Refresh all facts in the Series $targetSeries
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
		Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ __Mixed Product__ < 5yrs Series): if the patient has 1 dose of a prior or current (any) formulation administered prior to the season start date at < 5yrs of age, set the recommendation dose number to 2"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	salience 999
	no-loop true
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023MixedProductLT5ySeries"
			- the Series is not complete
			- make note of the effective dose number in the Series as $effectiveDoseNumber
			- the numeric $effectiveDoseNumber is <= 2
			- the dose number to recommend is < 2
			- make note of the season start date as $seasonStartDate
		// Obtain the most recent dose in the prior season
		There is an administered shot $previousShot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			/////// - the administration date of the shot is < "12-Sep-2023"
			- the administration date of the shot is < $seasonStartDate
			- that has already been evaluated and whose shot validity is VALID
			- the vaccine administered a member of ("ICE207", "ICE208", "ICE210", "ICE211", "ICE212", "ICE213", "ICE217", "ICE218", "ICE219", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE308", "ICE309", "ICE310", "ICE311", "ICE312", "ICE502", "ICE510", "ICE511", "ICE519", "ICE520")
			- make note of the date this shot was administered as $administrationDate
			- make note of the associated series as $associatedPriorSeasonSeries
		// We want to run this rule for one and only one dose from the prior season; therefore, make sure we're looking at the most recent dose in that season
		There does not exist an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			/////// - the administration date of the shot is < "12-Sep-2023"
			- the administration date of the shot is < $seasonStartDate
			- the administration date of the shot is > $administrationDate
			- that has already been evaluated and whose shot validity is VALID
			- the vaccine administered a member of ("ICE207", "ICE208", "ICE210", "ICE211", "ICE212", "ICE213", "ICE217", "ICE218", "ICE219", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE308", "ICE309", "ICE310", "ICE311", "ICE312", "ICE502", "ICE510", "ICE511", "ICE519", "ICE520")
		// Now check to make sure there is not a different dose in the prior season
		There does not exist an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- that is not the same shot as $previousShot
			/////// - the administration date of the shot is < "12-Sep-2023"
			- the administration date of the shot is < $seasonStartDate
			- the administration date of the shot is != $administrationDate
			- that has already been evaluated and whose shot validity is VALID
			- the vaccine administered a member of ("ICE207", "ICE208", "ICE210", "ICE211", "ICE212", "ICE213", "ICE217", "ICE218", "ICE219", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE308", "ICE309", "ICE310", "ICE311", "ICE312", "ICE502", "ICE510", "ICE511", "ICE519", "ICE520")
	then
		Skip Series Dose Number to 2 from $effectiveDoseNumber for Disease "SUPPORTED_DISEASE_CONCEPT.079.89" in Series $targetSeries but do not refresh series facts
		Set the Dose Number of Recommendation Forecast to 2 in Series $targetSeries
		Refresh all facts in the Series $targetSeries
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
		Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ __Mixed Product__ < 5yrs Series): if the patient has >= 2 doses of a prior (any) formulation administered prior to the season start date at < 5yrs of age, set the recommendation dose number to 3"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	salience 999
	no-loop true
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023MixedProductLT5ySeries"
			- the Series is not complete
			- make note of the effective dose number in the Series as $effectiveDoseNumber
			- the numeric $effectiveDoseNumber is <= 3
			- the dose number to recommend is < 3
			- make note of the season start date as $seasonStartDate
		// Obtain the most recent dose in the prior season
		There is an administered shot $previousShot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			/////// - the administration date of the shot is < "12-Sep-2023"
			- the administration date of the shot is < $seasonStartDate
			- that has already been evaluated and whose shot validity is VALID
			- the vaccine administered a member of ("ICE207", "ICE208", "ICE210", "ICE211", "ICE212", "ICE213", "ICE217", "ICE218", "ICE219", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE308", "ICE309", "ICE310", "ICE311", "ICE312", "ICE502", "ICE510", "ICE511", "ICE519", "ICE520")
			- make note of the date this shot was administered as $administrationDate
			- make note of the associated series as $priorSeasonSeries
		// We want to run this rule for one and only one dose from the prior season; therefore, make sure we're looking at the most recent dose in that season
		There does not exist an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the shot belongs to the series $priorSeasonSeries
			/////// - the administration date of the shot is < "12-Sep-2023"
			- the administration date of the shot is < $seasonStartDate
			- the administration date of the shot is > $administrationDate
			- that has already been evaluated and whose shot validity is VALID
			- the vaccine administered a member of ("ICE207", "ICE208", "ICE210", "ICE211", "ICE212", "ICE213", "ICE217", "ICE218", "ICE219", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE308", "ICE309", "ICE310", "ICE311", "ICE312", "ICE502", "ICE510", "ICE511", "ICE519", "ICE520")
		// Now check to make sure there is a different dose in the prior season in the same series
		There exists an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- that is not the same shot as $previousShot
			- the shot belongs to the series $priorSeasonSeries
			/////// - the administration date of the shot is < "12-Sep-2023"
			- the administration date of the shot is < $seasonStartDate
			- that has already been evaluated and whose shot validity is VALID
			- the vaccine administered a member of ("ICE207", "ICE208", "ICE210", "ICE211", "ICE212", "ICE213", "ICE217", "ICE218", "ICE219", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE308", "ICE309", "ICE310", "ICE311", "ICE312", "ICE502", "ICE510", "ICE511", "ICE519", "ICE520")
	then
		Skip Series Dose Number to 3 from $effectiveDoseNumber for Disease "SUPPORTED_DISEASE_CONCEPT.079.89" in Series $targetSeries but do not refresh series facts
		Set the Dose Number of Recommendation Forecast to 3 in Series $targetSeries
		Refresh all facts in the Series $targetSeries
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
		Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ __Moderna__ < 5yrs Series): if the patient has >= 1 doses of a priori Moderna formulation administered prior to the season start date at < 5yrs of age, set the recommendation dose number to 2"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	salience 999
	no-loop true
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023ModernaLT5ySeries"
			- the Series is not complete
			- make note of the effective dose number in the Series as $effectiveDoseNumber
			- the numeric $effectiveDoseNumber is <= 2
			- the dose number to recommend is < 2
			- make note of the season start date as $seasonStartDate
		// Obtain the most recent dose in the prior season
		There is an administered shot $previousShot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			/////// - the administration date of the shot is < "12-Sep-2023"
			- the administration date of the shot is < $seasonStartDate
			- that has already been evaluated and whose shot validity is VALID
			- the vaccine administered a member of ("ICE207", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE311", "ICE312", "ICE519")
			- make note of the date this shot was administered as $administrationDate
			- make note of the associated series as $priorSeasonSeries
		// We want to run this rule for one and only one dose from the prior season; therefore, make sure we're looking at the most recent dose in that season
		There does not exist an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the shot belongs to the series $priorSeasonSeries
			/////// - the administration date of the shot is < "12-Sep-2023"
			- the administration date of the shot is < $seasonStartDate
			- the administration date of the shot is > $administrationDate
			- that has already been evaluated and whose shot validity is VALID
			- the vaccine administered a member of ("ICE207", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE311", "ICE312", "ICE519")
	then
		Skip Series Dose Number to 2 from $effectiveDoseNumber for Disease "SUPPORTED_DISEASE_CONCEPT.079.89" in Series $targetSeries but do not refresh series facts
		Set the Dose Number of Recommendation Forecast to 2 in Series $targetSeries
		Refresh all facts in the Series $targetSeries
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
		Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(Sep2023+ __Novavax__ Series): If CVX 313 was administered for dose 1 or dose 2, dose 3 is not needed. Skip to target dose 4"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule^COVID19Sep2023Season"
	salience 999
	no-loop true
	when
		There is a Series $targetSeries that needs forecasting
			- the Series belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series is "COVID19Sep2023NovavaxSeries"
			- make note of the effective dose number in the Series as $effectiveDoseNumber
			- the numeric $effectiveDoseNumber is == 3			
		There is an administered shot $cvx313dose1or2
			- the shot belongs to the Series $targetSeries
			- that has already been evaluated and whose shot validity is VALID
			- the vaccine administered is "ICE313"
			- the dose number in the Series is <= 2
	then
		Skip Series Dose Number to 4 from $effectiveDoseNumber for Disease "SUPPORTED_DISEASE_CONCEPT.079.89" in Series $targetSeries but do not refresh series facts
		Set the Dose Number of Recommendation Forecast to 4 in Series $targetSeries
		Refresh all facts in the Series $targetSeries
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
		Log that this Series Rule fired for the Series $targetSeries
end

/*************************************************************************************************************************************************************************************
 END __SKIP DOSE__ Logic for < 5 yrs Series  (Pfizer, Moderna, Mixed Product, Novavax)
/************************************************************************************************************************************************************************************/
